<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Visor Conurbano - √çndice de Riesgo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }

    .legend { 
      background: white; 
      padding: 6px 8px; 
      font: 14px Arial; 
      box-shadow: 0 0 15px rgba(0,0,0,0.2); 
    }

    /* üîç Estilos del buscador */
    #searchBox {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      border-radius: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      padding: 5px 10px;
      display: flex;
      align-items: center;
    }

    #searchInput {
      border: none;
      outline: none;
      font-size: 14px;
      padding: 5px;
      width: 250px;
    }

    #searchButton {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h3 style="margin:4px; font-family:Arial;">Mapa del Conurbano: √çndice de Riesgo, Basurales y Cursos de Agua</h3>

  <!-- üîç Barra de b√∫squeda -->
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Buscar direcci√≥n..." />
    <button id="searchButton">üîç</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    // Inicializaci√≥n del mapa
    var map = L.map('map').setView([-34.65, -58.55], 10);

    // Capas base
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    var carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: '¬© OpenStreetMap, ¬© Carto'
    });

    var baseMaps = { "OpenStreetMap": osm, "Carto Light": carto };

    // URLs de capas GeoJSON
    var urlBasurales = "https://raw.githubusercontent.com/santy997/conurbano_basurales_y_rellenos/refs/heads/main/conurbano_basurales_y_rellenos.geojson";
    var urlCursos = "https://raw.githubusercontent.com/santy997/conurbano_curso_de_agua/refs/heads/main/conurbano_curso_de_agua.geojson";
    var urlRiesgo = "https://raw.githubusercontent.com/santy997/capa_que_sirve/refs/heads/main/capa_que_sirve.geojson";

    // Funci√≥n de colores
    function getColor(valor) {
      valor = parseFloat(valor);
      if (isNaN(valor)) return '#CCCCCC';
      if (valor < 0.22) return '#4CAF50';
      else if (valor < 0.45) return '#FFEB3B';
      else return '#F44336';
    }

    // Estilo de pol√≠gonos
    function styleRiesgo(feature) {
      return {
        fillColor: getColor(feature.properties["capap para unir  ‚Äî Hoja 1_indac"]),
        weight: 1,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
      };
    }

    // Popups
    function onEachFeatureRiesgo(feature, layer) {
      if (feature.properties && feature.properties["capap para unir  ‚Äî Hoja 1_indac"] !== undefined) {
        layer.bindPopup("<b>√çndice de riesgo:</b> " + feature.properties["capap para unir  ‚Äî Hoja 1_indac"]);
      }
    }

    // Cargar capas
    var riesgoLayer, cursosLayer, basuralesLayer;

    fetch(urlRiesgo)
      .then(resp => resp.json())
      .then(dataRiesgo => {
        riesgoLayer = L.geoJSON(dataRiesgo, { style: styleRiesgo, onEachFeature: onEachFeatureRiesgo }).addTo(map);

        fetch(urlCursos)
          .then(resp => resp.json())
          .then(dataCursos => {
            cursosLayer = L.geoJSON(dataCursos, { style: { color: '#2196F3', weight: 2, opacity: 0.8 } }).addTo(map);

            fetch(urlBasurales)
              .then(resp => resp.json())
              .then(dataBasurales => {
                basuralesLayer = L.geoJSON(dataBasurales, {
                  pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                      radius: 5,
                      fillColor: "#000000",
                      color: "#000000",
                      weight: 1,
                      opacity: 1,
                      fillOpacity: 0.9
                    });
                  }
                }).addTo(map);

                // Control de capas
                var overlayMaps = {
                  "√çndice de riesgo": riesgoLayer,
                  "Cursos de agua": cursosLayer,
                  "Basurales y rellenos": basuralesLayer
                };
                L.control.layers(baseMaps, overlayMaps, { collapsed:false }).addTo(map);

                map.fitBounds(riesgoLayer.getBounds());
              });
          });
      })
      .catch(err => console.error("Error cargando capas:", err));

    // Leyenda
    var legend = L.control({position: "bottomright"});
    legend.onAdd = function () {
      var div = L.DomUtil.create("div", "legend");
      div.innerHTML =
        "<b>√çndice de riesgo</b><br>" +
        "<i style='background:#4CAF50; width:18px; height:18px; float:left; margin-right:6px; opacity:0.7;'></i> Bajo (0.00‚Äì0.22)<br>" +
        "<i style='background:#FFEB3B; width:18px; height:18px; float:left; margin-right:6px; opacity:0.7;'></i> Medio (0.22‚Äì0.45)<br>" +
        "<i style='background:#F44336; width:18px; height:18px; float:left; margin-right:6px; opacity:0.7;'></i> Alto (‚â•0.45)";
      return div;
    };
    legend.addTo(map);

    // üîç Buscador de direcciones
    let marcador = null;
    async function buscarDireccion() {
      const direccion = document.getElementById('searchInput').value.trim();
      if (!direccion) return alert("Escrib√≠ una direcci√≥n para buscar.");

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&addressdetails=1&limit=1`;

      try {
        const resp = await fetch(url, { headers: { 'User-Agent': 'VisorConurbano/1.0' } });
        const data = await resp.json();

        if (data.length === 0) {
          alert("No se encontr√≥ la direcci√≥n.");
          return;
        }

        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        const displayName = data[0].display_name;

        // Centrar mapa sin perder visibilidad de capas
        map.setView([lat, lon], 12);  // zoom 12 para ver contexto
        if (marcador) marcador.remove();
        marcador = L.marker([lat, lon], { riseOnHover: true }).addTo(map)
          .bindPopup(`<b>${displayName}</b><br>Lat: ${lat.toFixed(5)}<br>Lon: ${lon.toFixed(5)}`)
          .openPopup();
      } catch(e) {
        alert("Error al buscar direcci√≥n.");
        console.error(e);
      }
    }

    document.getElementById('searchButton').addEventListener('click', buscarDireccion);
    document.getElementById('searchInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') buscarDireccion();
    });

  </script>
</body>
</html>
